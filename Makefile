CXX=gcc

CXXFLAGS_GENERIC=-O2 -fopenmp -lm
CXXFLAGS_HASWELL = -DTEST_NAME="\"Haswell - 256 bits\"" -DAVX_256_10 -DN_THREADS=8   -march=core-avx2 $(CXXFLAGS_GENERIC)
CXXFLAGS_KNL     = -DTEST_NAME="\"KNL - 512 bits\""     -DAVX_512_12 -DN_THREADS=256 -march=knl       $(CXXFLAGS_GENERIC)
CXXFLAGS_ZEN_PLUS= -DTEST_NAME="\"ZEN+ - 256 bits\""    -DAVX_256_10 -DN_THREADS=12  -march=znver1    $(CXXFLAGS_GENERIC)

MAIN=main.c getarg.c
ARCH_DIR=Arch

HASWELL=$(ARCH_DIR)/256_10.c
HASWELL_HEADERS=$(ARCH_DIR)/256_10.h

ZEN_PLUS=$(ARCH_DIR)/256_10.c
ZEN_PLUS_HEADERS=$(ARCH_DIR)/256_10.h

KNL=$(ARCH_DIR)/512_12.c
KNL_HEADERS=$(ARCH_DIR)/512_12.h

OUTPUT_HASWELL=haswell_256
OUTPUT_ZEN_PLUS=zen_plus_256
OUTPUT_KNL=knl_512

all: $(OUTPUT_HASWELL) $(OUTPUT_KNL) $(OUTPUT_ZEN_PLUS)

$(OUTPUT_HASWELL): Makefile $(MAIN) $(HASWELL) $(HASWELL_HEADERS)
	$(CXX) $(CXXFLAGS_HASWELL) $(MAIN) $(HASWELL) -o $(OUTPUT_HASWELL)

$(OUTPUT_ZEN_PLUS): Makefile $(MAIN) $(ZEN_PLUS) $(ZEN_PLUS_HEADERS)
	$(CXX) $(CXXFLAGS_ZEN_PLUS) $(MAIN) $(ZEN_PLUS) -o $(OUTPUT_ZEN_PLUS)

$(OUTPUT_KNL): Makefile $(MAIN) $(KNL) $(KNL_HEADERS)
	$(CXX) $(CXXFLAGS_KNL) $(MAIN) $(KNL) -o $(OUTPUT_KNL)

clean:
	@rm $(OUTPUT_HASWELL) $(OUTPUT_KNL) $(OUTPUT_ZEN_PLUS)
